#!/usr/bin/env python3
"""
Check if component bugs would have caused 0.0 values in historical trades
"""

from droplet_client import DropletClient

def main():
    client = DropletClient()
    
    try:
        print("=" * 80)
        print("COMPONENT BUG IMPACT ANALYSIS")
        print("=" * 80)
        print()
        
        result = client.execute_command(
            "cd ~/stock-bot && source venv/bin/activate && python3 << 'PYEOF'\n"
            "import sys\n"
            "sys.path.insert(0, '.')\n"
            "from pathlib import Path\n"
            "import json\n"
            "\n"
            "print('SIMULATING COMPONENT CALCULATIONS WITH OLD VS NEW LOGIC:')\n"
            "print('=' * 80)\n"
            "print()\n"
            "\n"
            "# Load recent cache data to simulate\n"
            "from main import read_uw_cache\n"
            "from uw_enrichment_v2 import enrich_signal\n"
            "from uw_composite_v2 import compute_composite_score_v3, _to_num\n"
            "\n"
            "cache = read_uw_cache()\n"
            "symbol = 'AAPL'\n"
            "enriched = enrich_signal(symbol, cache, 'mixed')\n"
            "\n"
            "print('SIMULATING OLD (BUGGY) LOGIC:')\n"
            "print('-' * 80)\n"
            "\n"
            "# Simulate old greeks_gamma logic (looked for gamma_exposure directly)\n"
            "greeks_data = enriched.get('greeks', {})\n"
            "old_gamma_exposure = _to_num(greeks_data.get('gamma_exposure', 0))\n"
            "call_gamma = _to_num(greeks_data.get('call_gamma', 0))\n"
            "put_gamma = _to_num(greeks_data.get('put_gamma', 0))\n"
            "new_gamma_exposure = call_gamma - put_gamma if old_gamma_exposure == 0 else old_gamma_exposure\n"
            "\n"
            "print(f'greeks_gamma:')\n"
            "print(f'  Old logic: gamma_exposure = {old_gamma_exposure}')\n"
            "print(f'  New logic: gamma_exposure = {new_gamma_exposure} (from call_gamma={call_gamma}, put_gamma={put_gamma})')\n"
            "print(f'  Old would contribute: {abs(old_gamma_exposure) > 100000}')\n"
            "print(f'  New would contribute: {abs(new_gamma_exposure) > 10000}')\n"
            "print()\n"
            "\n"
            "# Simulate old iv_rank logic (only < 20 or > 80)\n"
            "iv_data = enriched.get('iv_rank', {}) or enriched.get('iv', {})\n"
            "iv_rank_val = _to_num(iv_data.get('iv_rank', iv_data.get('iv_rank_1y', 50)))\n"
            "old_iv_contributes = iv_rank_val < 20 or iv_rank_val > 80\n"
            "new_iv_contributes = iv_rank_val < 20 or iv_rank_val > 80 or (30 <= iv_rank_val <= 70)\n"
            "\n"
            "print(f'iv_rank:')\n"
            "print(f'  Value: {iv_rank_val}')\n"
            "print(f'  Old logic contributes: {old_iv_contributes} (only < 20 or > 80)')\n"
            "print(f'  New logic contributes: {new_iv_contributes} (includes 30-70 range)')\n"
            "print()\n"
            "\n"
            "# Simulate old oi_change logic (looked for 'oi' key)\n"
            "oi_data_old = enriched.get('oi', {})\n"
            "oi_data_new = enriched.get('oi_change', {}) or enriched.get('oi', {})\n"
            "old_net_oi = _to_num(oi_data_old.get('net_oi_change', 0))\n"
            "new_net_oi = _to_num(oi_data_new.get('net_oi_change', 0))\n"
            "if new_net_oi == 0:\n"
            "    curr_oi = _to_num(oi_data_new.get('curr_oi', 0))\n"
            "    volume = _to_num(oi_data_new.get('volume', 0))\n"
            "    if volume > 0:\n"
            "        new_net_oi = volume * 0.1\n"
            "\n"
            "print(f'oi_change:')\n"
            "print(f'  Old logic: net_oi = {old_net_oi} (from oi key)')\n"
            "print(f'  New logic: net_oi = {new_net_oi} (from oi_change key or calculated)')\n"
            "print(f'  Old would contribute: {old_net_oi > 10000}')\n"
            "print(f'  New would contribute: {new_net_oi > 1000}')\n"
            "print()\n"
            "\n"
            "# Simulate old regime logic (only RISK_ON/RISK_OFF)\n"
            "regime = 'mixed'\n"
            "flow_sign = 1\n"
            "old_regime_factor = 1.0  # mixed not handled\n"
            "new_regime_factor = 1.02  # mixed handled\n"
            "\n"
            "print(f'regime_modifier:')\n"
            "print(f'  Regime: {regime}')\n"
            "print(f'  Old logic: factor = {old_regime_factor} (mixed not handled)')\n"
            "print(f'  New logic: factor = {new_regime_factor} (mixed handled)')\n"
            "print()\n"
            "\n"
            "# Calculate impact\n"
            "print('IMPACT CALCULATION:')\n"
            "print('-' * 80)\n"
            "\n"
            "from uw_composite_v2 import get_weight\n"
            "\n"
            "# greeks_gamma\n"
            "greeks_weight = get_weight('greeks_gamma')\n"
            "if abs(new_gamma_exposure) > 10000:\n"
            "    new_greeks_contrib = greeks_weight * 0.1\n"
            "else:\n"
            "    new_greeks_contrib = 0.0\n"
            "old_greeks_contrib = 0.0  # Would have been 0.0 with old logic\n"
            "\n"
            "print(f'greeks_gamma contribution:')\n"
            "print(f'  Old: {old_greeks_contrib:.4f}')\n"
            "print(f'  New: {new_greeks_contrib:.4f}')\n"
            "print(f'  Difference: +{new_greeks_contrib - old_greeks_contrib:.4f}')\n"
            "print()\n"
            "\n"
            "# iv_rank\n"
            "iv_weight = get_weight('iv_rank')\n"
            "if 30 <= iv_rank_val <= 70:\n"
            "    new_iv_contrib = iv_weight * 0.15\n"
            "else:\n"
            "    new_iv_contrib = 0.0\n"
            "old_iv_contrib = 0.0  # Would have been 0.0 with old logic (value is 50)\n"
            "\n"
            "print(f'iv_rank contribution:')\n"
            "print(f'  Old: {old_iv_contrib:.4f}')\n"
            "print(f'  New: {new_iv_contrib:.4f}')\n"
            "print(f'  Difference: +{new_iv_contrib - old_iv_contrib:.4f}')\n"
            "print()\n"
            "\n"
            "# oi_change\n"
            "oi_weight = get_weight('oi_change')\n"
            "if new_net_oi > 1000:\n"
            "    new_oi_contrib = oi_weight * 0.1\n"
            "else:\n"
            "    new_oi_contrib = 0.0\n"
            "old_oi_contrib = 0.0  # Would have been 0.0 with old logic\n"
            "\n"
            "print(f'oi_change contribution:')\n"
            "print(f'  Old: {old_oi_contrib:.4f}')\n"
            "print(f'  New: {new_oi_contrib:.4f}')\n"
            "print(f'  Difference: +{new_oi_contrib - old_oi_contrib:.4f}')\n"
            "print()\n"
            "\n"
            "# regime_modifier\n"
            "regime_weight = get_weight('regime_modifier')\n"
            "old_regime_contrib = regime_weight * (old_regime_factor - 1.0) * 2.0\n"
            "new_regime_contrib = regime_weight * (new_regime_factor - 1.0) * 2.0\n"
            "\n"
            "print(f'regime_modifier contribution:')\n"
            "print(f'  Old: {old_regime_contrib:.4f}')\n"
            "print(f'  New: {new_regime_contrib:.4f}')\n"
            "print(f'  Difference: +{new_regime_contrib - old_regime_contrib:.4f}')\n"
            "print()\n"
            "\n"
            "# Total impact\n"
            "total_old_contrib = old_greeks_contrib + old_iv_contrib + old_oi_contrib + old_regime_contrib\n"
            "total_new_contrib = new_greeks_contrib + new_iv_contrib + new_oi_contrib + new_regime_contrib\n"
            "total_difference = total_new_contrib - total_old_contrib\n"
            "\n"
            "print(f'TOTAL IMPACT:')\n"
            "print(f'  Old total: {total_old_contrib:.4f}')\n"
            "print(f'  New total: {total_new_contrib:.4f}')\n"
            "print(f'  Difference: +{total_difference:.4f}')\n"
            "print(f'  This would increase scores by ~{total_difference:.2f} points')\n"
            "print()\n"
            "PYEOF",
            timeout=120
        )
        print(result['stdout'])
        print()
        
    except Exception as e:
        print(f"[ERROR] Analysis failed: {e}")
        import traceback
        traceback.print_exc()
    finally:
        client.close()

if __name__ == "__main__":
    main()

